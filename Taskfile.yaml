version: '3'

vars:
  PATTERNS:
    sh: find ./tests/ -mindepth 1 -maxdepth 1 -type d

tasks:

  install:
    cmds:
    - rm -rf build
    - rm -rf cwl_chain_builder.egg-info
    - pip install -e .

  execute:
    cmds:
    - |
      cwl-chain-builder \
      --stage-in {{.PATTERN}}/stage-in.cwl \
      --workflow {{.PATTERN}}/workflow.cwl \
      --workflow-id water-bodies-detection \
      --stage-out {{.PATTERN}}/stage-out.cwl \
      --output {{.PATTERN}}/current.cwl
    - cwltool --validate {{.PATTERN}}/current.cwl

  execute_all:
    cmds:
    - for:
        var: PATTERNS
        as: PATTERN
      task: execute
      vars:
        PATTERN: "{{.PATTERN}}"

  print_expecteds:
    cmds:
    - for:
        var: PATTERNS
        as: PATTERN
      task: print_expected
      vars:
        PATTERN: "{{.PATTERN}}"

  print_expected:
    cmds:
    - cwltool --pack {{.PATTERN}}/expected.cwl | yq -P 
